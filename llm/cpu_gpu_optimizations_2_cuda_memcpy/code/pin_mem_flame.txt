#include <cstdio>
#include <cstdlib>
#include <cuda_runtime.h>

#define CHECK_CUDA(call)                                      \
do {                                                           \
    cudaError_t err = call;                                   \
    if (err != cudaSuccess) {                                  \
        fprintf(stderr, "CUDA error %s:%d: %s\n",              \
                __FILE__, __LINE__, cudaGetErrorString(err));  \
        exit(EXIT_FAILURE);                                    \
    }                                                           \
} while (0)

int main() {
    const size_t N = 50'000'000;        // 50M floats
    const int iterations = 50;
    size_t transfer_size = N * sizeof(float);

    for (int it = 0; it < iterations; it++) {

        float *host_mem;
        float *device_mem;

        CHECK_CUDA(cudaMallocHost((void **)&host_mem, transfer_size));
        CHECK_CUDA(cudaMalloc((void **)&device_mem, transfer_size));

        // Touch pages (important)
        for (size_t i = 0; i < N; i++)
            host_mem[i] = 1.0f;

        CHECK_CUDA(cudaMemcpy(
            device_mem,
            host_mem,
            transfer_size,
            cudaMemcpyHostToDevice
        ));

        CHECK_CUDA(cudaFreeHost(host_mem));
        CHECK_CUDA(cudaFree(device_mem));
    }

    printf("Done.\n");
    return 0;
}
